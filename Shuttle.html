<html>
<head>
   <title>Avissawella Shuttle</title>
    <meta charset="utf-8" />
    <script type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script> 

<script>

var pickupPoints = [
[6.954310, 80.204516] // Avissawella
, [6.940561, 80.137027] // Kosgama
, [6.918238, 80.098725] // Kaluaggala
, [6.903326, 80.087422] // Pahathgama
, [6.858726, 80.091433] // Meepe
, [6.851534, 80.050266] // Nawalamulla Rd
, [6.851713, 80.032687] // Godagama junc
, [6.877738, 79.989158] // Athurugiriya junc
, [6.883155, 79.979033] // Athurugiriya HW entrance
, [6.885680, 79.968753] // Rathnaramaya
, [6.891176, 79.964255] // Arangala
, [6.899884, 79.957607] // Godallawattha Rd
, [6.903918, 79.955043] // Malabe junc
, [6.905600, 79.963187] // Bridge
, [6.921804, 79.961663] // MIT
];

var refData = [
[6.882839050079866,79.97947111562631,'October 13, 2015 02:56:57.585']
,[6.8823345981999235,79.98014386708819,'October 13, 2015 02:56:45.024']
,[6.88187248341081,79.98170677664326,'October 13, 2015 02:56:32.089']
,[6.881504027303037,79.9831635327973,'October 13, 2015 02:56:19.263']
,[6.880781900042316,79.98405512000161,'October 13, 2015 02:56:07.817']
,[6.879552893542877,79.98492878128353,'October 13, 2015 02:55:56.423']
,[6.8792214287691165,79.98544940563562,'October 13, 2015 02:55:45.086']
,[6.879037160903775,79.98645514089299,'October 13, 2015 02:55:33.067']
,[6.878793085658279,79.98756367675757,'October 13, 2015 02:55:20.290']
,[6.878275069160197,79.98844546008318,'October 13, 2015 02:55:08.807']
,[6.877920032363691,79.98891382035707,'October 13, 2015 02:54:57.677']
,[6.877648851770766,79.98930626497261,'October 13, 2015 02:54:44.565']
,[6.877537503307774,79.98947128769353,'October 13, 2015 02:54:33.024']
,[6.877440812771627,79.98956998434639,'October 13, 2015 02:54:20.087']
,[6.8773742238984354,79.98964777742906,'October 13, 2015 02:54:08.045']
,[6.877095419457153,79.99004875171578,'October 13, 2015 02:53:56.426']
,[6.876761661558848,79.99054983864416,'October 13, 2015 02:53:44.953']
,[6.876325975722894,79.99110172384584,'October 13, 2015 02:53:33.480']
,[6.875752684182927,79.99187366425357,'October 13, 2015 02:53:21.635']
,[6.874212812058979,79.99391993319287,'October 13, 2015 02:52:55.356']
,[6.8734026095532945,79.99497849711659,'October 13, 2015 02:52:43.999']
,[6.872967310117531,79.99551107409638,'October 13, 2015 02:52:32.733']
,[6.872616528416982,79.99603724463294,'October 13, 2015 02:52:21.199']
,[6.871836007427587,79.9971626922681,'October 13, 2015 02:52:10.037']
,[6.871087312884001,79.99818682630435,'October 13, 2015 02:51:58.945']
,[6.8708431710130675,79.9984710347821,'October 13, 2015 02:51:47.801']
,[6.87035443353349,79.99911268788259,'October 13, 2015 02:51:36.443']
,[6.869683741611308,79.99997138020682,'October 13, 2015 02:51:25.129']
,[6.868856727166842,80.00100396698396,'October 13, 2015 02:51:12.505']
,[6.866846409481272,80.00343014439589,'October 13, 2015 02:50:45.243']
,[6.866742903645509,80.0035507899491,'October 13, 2015 02:50:31.956']
,[6.866381196879368,80.00404084381981,'October 13, 2015 02:50:18.930']
,[6.865107200710753,80.00558631573631,'October 13, 2015 02:50:06.475']
,[6.864505623465357,80.00704293849655,'October 13, 2015 02:49:54.446']
,[6.864422181458789,80.00853574734104,'October 13, 2015 02:49:40.058']
,[6.8646190893701595,80.00980260967239,'October 13, 2015 02:49:27.600']
,[6.865073215479017,80.0110894303347,'October 13, 2015 02:49:15.285']
,[6.865453790689904,80.01204647257381,'October 13, 2015 02:49:01.937']
,[6.865528842824016,80.01291736947204,'October 13, 2015 02:48:49.094']
,[6.865666103312856,80.01356551783523,'October 13, 2015 02:48:37.854']
,[6.865730238449945,80.01400702839916,'October 13, 2015 02:48:25.999']
,[6.8656487846867424,80.01513504028111,'October 13, 2015 02:48:11.496']
,[6.865719092270625,80.01647583052683,'October 13, 2015 02:47:57.594']
,[6.865842354291154,80.01733385510357,'October 13, 2015 02:47:42.941']
,[6.865863377278556,80.01873800711685,'October 13, 2015 02:47:30.969']
,[6.865763013549459,80.02022592663573,'October 13, 2015 02:47:19.116']
,[6.8654070015034785,80.02238698644804,'October 13, 2015 02:47:07.849']
,[6.864885296575352,80.02344622134846,'October 13, 2015 02:46:53.185']
,[6.86434189815891,80.02423280106898,'October 13, 2015 02:46:40.792']
,[6.863298329380462,80.02557255216685,'October 13, 2015 02:46:28.628']
,[6.862180113800996,80.02697320918146,'October 13, 2015 02:46:12.532']
,[6.860791237398274,80.02762318856367,'October 13, 2015 02:45:52.820']
,[6.859190824749662,80.02830677687962,'October 13, 2015 02:45:40.523']
,[6.8576622157606835,80.0291512236303,'October 13, 2015 02:45:28.790']
,[6.856139332738661,80.03054428985567,'October 13, 2015 02:45:17.140']
,[6.854153374695739,80.03161875847577,'October 13, 2015 02:45:03.990']
,[6.852880694391156,80.03217321066388,'October 13, 2015 02:44:50.843']
,[6.852014501762294,80.0325872957392,'October 13, 2015 02:44:38.155']
,[6.851732882555137,80.03293178732788,'October 13, 2015 02:44:26.576']
,[6.851779101041191,80.03320071298016,'October 13, 2015 02:44:15.364']
,[6.851779101041191,80.03320071298016,'October 13, 2015 02:44:01.280']
,[6.851784485016562,80.03323888675133,'October 13, 2015 02:43:49.652']
,[6.851842146234322,80.0335103427941,'October 13, 2015 02:43:38.382']
,[6.851949888050034,80.03385428315929,'October 13, 2015 02:43:27.009']
,[6.852071703475059,80.03431296376817,'October 13, 2015 02:43:14.548']
,[6.852091889289102,80.03441202203913,'October 13, 2015 02:43:03.317']
,[6.852091889289102,80.03441202203913,'October 13, 2015 02:42:50.772']
,[6.85211136488448,80.034477931033,'October 13, 2015 02:42:39.582']
,[6.85211136488448,80.034477931033,'October 13, 2015 02:42:25.858']
,[6.852253564412221,80.03490868443427,'October 13, 2015 02:42:13.178']
,[6.85275537782828,80.03623609761165,'October 13, 2015 02:41:59.271']
,[6.853000031859102,80.03726211309213,'October 13, 2015 02:41:47.490']
,[6.853091743764171,80.03774587029274,'October 13, 2015 02:41:35.694']
,[6.853151471890764,80.0382907187871,'October 13, 2015 02:41:24.512']
,[6.853215023108472,80.03920904765029,'October 13, 2015 02:41:14.017']
,[6.853223323143051,80.03990630661569,'October 13, 2015 02:41:00.643']
,[6.853210254233076,80.04000677548059,'October 13, 2015 02:40:47.908']
,[6.853108765111424,80.0405341771489,'October 13, 2015 02:40:32.473']
,[6.852768580687051,80.04183236658271,'October 13, 2015 02:40:21.272']
,[6.85258856751508,80.04260195103473,'October 13, 2015 02:39:47.863']
,[6.852324208006643,80.04361972891859,'October 13, 2015 02:39:35.509']
,[6.852100857472801,80.04440801357322,'October 13, 2015 02:39:21.775']
,[6.851944752187576,80.04485228641435,'October 13, 2015 02:39:10.426']
,[6.851512495349678,80.04657781154407,'October 13, 2015 02:38:45.787']
,[6.851273820249469,80.04748660833809,'October 13, 2015 02:38:32.529']
,[6.851183071311693,80.04951983416805,'October 13, 2015 02:38:20.561']
,[6.851424831968416,80.05005627891089,'October 13, 2015 02:37:57.049']
,[6.851470006260265,80.05017460136621,'October 13, 2015 02:37:45.959']
,[6.851459870178495,80.05120750585097,'October 13, 2015 02:37:34.190']
,[6.851752097890427,80.05217319708788,'October 13, 2015 02:37:21.626']
,[6.854511526104497,80.05491030104555,'October 13, 2015 02:36:29.527']
,[6.855050967392518,80.05649538601003,'October 13, 2015 02:36:10.739']
,[6.8552150492572554,80.05748763507768,'October 13, 2015 02:35:59.190']
,[6.85520336364305,80.05816842815624,'October 13, 2015 02:35:47.828']
,[6.855098767938418,80.0590898966563,'October 13, 2015 02:35:35.370']
,[6.8551757867164715,80.06031343837806,'October 13, 2015 02:35:20.975']
,[6.856079563239201,80.06640913930964,'October 13, 2015 02:34:29.151']
,[6.855898686831259,80.06789551581693,'October 13, 2015 02:34:12.241']
,[6.855563840758453,80.0693693886665,'October 13, 2015 02:33:56.377']
,[6.854974095815952,80.07080224680308,'October 13, 2015 02:33:39.879']
,[6.854638392937482,80.0729822566223,'October 13, 2015 02:33:22.522']
,[6.8545638047468955,80.07452736728787,'October 13, 2015 02:33:01.641']
,[6.8549671497702125,80.07553460192268,'October 13, 2015 02:32:48.315']
,[6.8548169960883625,80.07645303965005,'October 13, 2015 02:32:36.349']
,[6.854524618848314,80.07758184425582,'October 13, 2015 02:32:24.985']
,[6.8543338364091975,80.0790846262689,'October 13, 2015 02:32:11.605']
,[6.854124592029595,80.08078363296306,'October 13, 2015 02:31:58.263']
,[6.85372934001743,80.0813472413016,'October 13, 2015 02:31:43.847']
,[6.853133801264193,80.08281087251248,'October 13, 2015 02:31:31.554']
,[6.853078043330333,80.08373669657973,'October 13, 2015 02:31:19.770']
,[6.85255212323569,80.08523945331338,'October 13, 2015 02:31:08.079']
,[6.852566244463286,80.0864735883072,'October 13, 2015 02:30:53.924']
,[6.85334913492867,80.08777883023514,'October 13, 2015 02:30:42.205']
,[6.853946238567069,80.08876386963476,'October 13, 2015 02:30:27.385']
,[6.854640052509228,80.08935878125429,'October 13, 2015 02:30:12.431']
,[6.855649724968795,80.08957671304294,'October 13, 2015 02:30:01.176']
,[6.856953422562741,80.0898507330037,'October 13, 2015 02:29:49.621']
,[6.857779424201038,80.09050436359699,'October 13, 2015 02:29:32.910']
,[6.858517207759086,80.0912242215464,'October 13, 2015 02:29:20.490']
,[6.859344427908265,80.0913173933689,'October 13, 2015 02:29:09.030']
,[6.860274030833264,80.09080103893712,'October 13, 2015 02:28:56.771']
,[6.861117568600113,80.0904766093657,'October 13, 2015 02:28:44.893']
,[6.862311299240867,80.0902108873718,'October 13, 2015 02:28:32.279']
,[6.863569465662759,80.08992390629419,'October 13, 2015 02:28:19.335']
,[6.864836283142604,80.089545865564,'October 13, 2015 02:28:06.542']
,[6.866204576097021,80.08921892634241,'October 13, 2015 02:27:50.243']
,[6.867322712756297,80.08889531041244,'October 13, 2015 02:27:35.513']
,[6.868592716765209,80.08853364379056,'October 13, 2015 02:27:24.317']
,[6.869741654228646,80.08803896402651,'October 13, 2015 02:27:13.208']
,[6.870553666377791,80.08760250353663,'October 13, 2015 02:27:01.794']
,[6.8722142324786075,80.08709646014822,'October 13, 2015 02:26:50.691']
,[6.873558932115764,80.08679315564324,'October 13, 2015 02:26:37.533']
,[6.874696464322744,80.08673868849506,'October 13, 2015 02:26:24.903']
,[6.8762914942477025,80.08677128416542,'October 13, 2015 02:26:11.925']
,[6.877776862127357,80.08680484547405,'October 13, 2015 02:25:59.246']
,[6.87929181014498,80.08655177813756,'October 13, 2015 02:25:47.939']
,[6.880585778993812,80.08599335703123,'October 13, 2015 02:25:36.838']
,[6.8822598907418,80.08546142065725,'October 13, 2015 02:25:24.041']
,[6.883218035027461,80.08537221925198,'October 13, 2015 02:25:10.905']
,[6.884126097535803,80.085832195672,'October 13, 2015 02:24:59.789']
,[6.88490730277159,80.08661215560264,'October 13, 2015 02:24:48.524']
,[6.886693458777143,80.08820145828709,'October 13, 2015 02:24:36.278']
,[6.888360357651561,80.0886927829796,'October 13, 2015 02:24:16.170']
,[6.890301265833765,80.08865785464623,'October 13, 2015 02:24:01.599']
,[6.894607356070944,80.08804470234408,'October 13, 2015 02:23:46.209']
,[6.895946846044289,80.0880060633586,'October 13, 2015 02:23:08.477']
,[6.8975272524102,80.08798478717416,'October 13, 2015 02:22:52.162']
,[6.898839311716055,80.08779336968449,'October 13, 2015 02:22:37.938']
,[6.900517071269874,80.087801403623,'October 13, 2015 02:22:25.971']
,[6.901668240334434,80.0877386381668,'October 13, 2015 02:22:11.608']
,[6.902241967591497,80.08767112132014,'October 13, 2015 02:21:59.837']
,[6.902577328925351,80.08758374970876,'October 13, 2015 02:21:47.451']
,[6.903204885317863,80.0874614387985,'October 13, 2015 02:21:33.457']
,[6.903771679596238,80.0878919577256,'October 13, 2015 02:21:21.164']
,[6.903787006818427,80.08789940710747,'October 13, 2015 02:21:08.169']
,[6.9045322547743675,80.0885905751812,'October 13, 2015 02:20:53.058']
,[6.9056127294978165,80.08959268757248,'October 13, 2015 02:20:40.213']
,[6.906642191941541,80.09047879527083,'October 13, 2015 02:20:27.853']
,[6.9076098721361685,80.09127878867983,'October 13, 2015 02:20:15.490']
,[6.908866316296335,80.09197048577994,'October 13, 2015 02:20:02.717']
,[6.910095364234684,80.09257722755277,'October 13, 2015 02:19:51.353']
,[6.911166378836987,80.09346692463754,'October 13, 2015 02:19:40.112']
,[6.9118421719487735,80.09432962128358,'October 13, 2015 02:19:28.655']
,[6.912571692225363,80.09531340465621,'October 13, 2015 02:19:17.380']
,[6.913254575115082,80.09627235488587,'October 13, 2015 02:19:05.774']
,[6.913921590781495,80.09717479219181,'October 13, 2015 02:18:52.719']
,[6.915057689632811,80.09803610158943,'October 13, 2015 02:18:39.910']
,[6.916010024785971,80.09836568387551,'October 13, 2015 02:18:25.304']
,[6.91716277938548,80.09828981244942,'October 13, 2015 02:18:13.557']
,[6.917932787174912,80.09842334349645,'October 13, 2015 02:18:02.938']
,[6.918212619037222,80.09861333985833,'October 13, 2015 02:17:52.513']
,[6.918318825416105,80.09864484668148,'October 13, 2015 02:17:41.284']
,[6.919003854430828,80.09934434283042,'October 13, 2015 02:17:16.450']
,[6.919051873637916,80.10003094494776,'October 13, 2015 02:17:04.131']
,[6.918535743067723,80.10080990253103,'October 13, 2015 02:16:52.358']
,[6.918337216364652,80.10188424224388,'October 13, 2015 02:16:39.649']
,[6.918733160450531,80.10320817518623,'October 13, 2015 02:16:25.955']
,[6.919484999144715,80.1046988501436,'October 13, 2015 02:16:10.426']
,[6.920222188515916,80.1055449874923,'October 13, 2015 02:15:57.863']
,[6.920979596828751,80.1063084244259,'October 13, 2015 02:15:46.109']
,[6.921714099410306,80.10704775231069,'October 13, 2015 02:15:34.939']
,[6.922213929036405,80.10766558438503,'October 13, 2015 02:15:23.714']
,[6.9225458191427585,80.10810190532106,'October 13, 2015 02:15:12.366']
,[6.922899765734038,80.10857800710002,'October 13, 2015 02:15:00.119']
,[6.923611269443165,80.10969160151613,'October 13, 2015 02:14:47.744']
,[6.924065948939467,80.11039236270831,'October 13, 2015 02:14:34.680']
,[6.9247228271451435,80.1114931558458,'October 13, 2015 02:14:22.355']
,[6.925325822316827,80.11234625676916,'October 13, 2015 02:14:09.833']
,[6.926051920025122,80.11390529383846,'October 13, 2015 02:13:58.327']
,[6.926604173019409,80.11445696462187,'October 13, 2015 02:13:43.071']
,[6.927684844008143,80.1150118834786,'October 13, 2015 02:13:31.811']
,[6.9289378308730125,80.1154180750058,'October 13, 2015 02:13:16.533']
,[6.929786872205708,80.11606142278482,'October 13, 2015 02:13:04.674']
,[6.931018223795377,80.1170391482781,'October 13, 2015 02:12:53.053']
,[6.9322573235309415,80.11804944105928,'October 13, 2015 02:12:41.267']
,[6.933109828579867,80.1196200041206,'October 13, 2015 02:12:29.324']
,[6.933531247616208,80.12112237715621,'October 13, 2015 02:12:17.019']
,[6.933973489370251,80.1222957793192,'October 13, 2015 02:12:04.212']
,[6.935003473411877,80.1234490796625,'October 13, 2015 02:11:48.530']
,[6.935690120740411,80.1239584176835,'October 13, 2015 02:11:35.278']
,[6.936612421972704,80.12472186916537,'October 13, 2015 02:11:22.049']
,[6.941529564560942,80.19645031215343,'October 13, 2015 01:54:33.495']
,[6.94218357178466,80.19679828138153,'October 13, 2015 01:54:10.058']
,[6.942843740848755,80.19705851342671,'October 13, 2015 01:53:58.956']
,[6.943431563481543,80.19717950564555,'October 13, 2015 01:53:47.482']
,[6.943816788252413,80.19728345892455,'October 13, 2015 01:53:36.675']
,[6.9438913241346985,80.19733295613622,'October 13, 2015 01:53:26.054']
,[6.944852992448881,80.19752461253547,'October 13, 2015 01:52:55.863']
,[6.945527650081385,80.19786599301061,'October 13, 2015 01:52:43.001']
,[6.945747319202125,80.1980054957116,'October 13, 2015 01:52:30.132']
,[6.946330989561732,80.19833769534762,'October 13, 2015 01:52:18.208']];


	var map = null;
	
	function start() 
	{
		setTimeout(function()
		{
			fetch();
		}, 500);
	}
	
	function fetch()
	{
		httpGetAsync("https://data.sparkfun.com/output/g6LjpEKYGLHYo88zvKR6/latest", onLocationReceive);
		setTimeout(fetch, 5000);
	}
	
	function onLocationReceive(latest)
	{
		var res = latest.split('"');
		if (res.length < 2)
			return;
		
		var coords = res[1].split(",");
		if (coords.length < 2)
			return;
		
        var lat = parseFloat(coords[0]);
        var lon = parseFloat(coords[1]);
		//alert("" + lat + "," + lon);
		
		if (map == null)
		{
			var cred = "AgWr8RK313_Rzdkdp82jBt5ewHXjagzL748PssnnME9qtHjoCvwLQWOTR97SihGF"; 
			map = new Microsoft.Maps.Map(document.getElementById("mapDiv"), { credentials: cred }); 
		
			var userLocation = new Microsoft.Maps.Location(lat, lon);
			map.setView({ center: userLocation, zoom: 15 });
		}
		
		var locs = new Array(); 
		locs.push(new Microsoft.Maps.Location(lat, lon - 0.000125)); 
		locs.push(new Microsoft.Maps.Location(lat - 0.0001, lon - 0.0001)); 
		locs.push(new Microsoft.Maps.Location(lat - 0.000125, lon)); 
		locs.push(new Microsoft.Maps.Location(lat - 0.0001, lon + 0.0001)); 
		locs.push(new Microsoft.Maps.Location(lat, lon + 0.000125)); 
		locs.push(new Microsoft.Maps.Location(lat + 0.0001, lon + 0.0001)); 
		locs.push(new Microsoft.Maps.Location(lat + 0.000125, lon)); 
		locs.push(new Microsoft.Maps.Location(lat + 0.0001, lon - 0.0001)); 
		locs.push(new Microsoft.Maps.Location(lat, lon - 0.000125)); 
		
		var locationArea = new Microsoft.Maps.Polygon(locs, { fillColor: new Microsoft.Maps.Color(100, 255, 100, 100), strokeColor: new Microsoft.Maps.Color(255, 255, 0, 0) });
		map.entities.clear();
		map.entities.push(locationArea);
		
		// Estimate arrival times
		for (var i = 0; i < pickupPoints.length; ++i)
		{
			var curIndex = findNearestPos(lat, lon);
			var pickupIndex = findNearestPos(pickupPoints[i][0], pickupPoints[i][1]);
			
			var s = "N/A";
			if (curIndex >= 0 && pickupIndex >= 0)
				s = diffTime(refData[pickupIndex][2], refData[curIndex][2]);
			
			var infoboxOptions = {width:75, height: 30, title: s, showPointer: true};
			var box = new Microsoft.Maps.Infobox(new Microsoft.Maps.Location(pickupPoints[i][0], pickupPoints[i][1]), infoboxOptions);
			map.entities.push(box);
		}
	}
	
	function httpGetAsync(theUrl, callback)
	{
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.onreadystatechange = function() { 
			if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
				callback(xmlHttp.responseText);
		}
		xmlHttp.open("GET", theUrl, true); // true for asynchronous 
		xmlHttp.send(null);
	}
	
	// Query ref data
	function findNearestPos(lat, lon)
	{
		var minDis = 1000000;
		var minIndex = -1;
		for (var i = 0; i < refData.length; ++i)
		{
			var a = refData[i][0];
			var b = refData[i][1];
			
			var d = Math.sqrt((a - lat) * (a - lat) + (b - lon) * (b - lon));
			if (d < minDis)
			{
				minDis = d;
				minIndex = i;
			}
		}
		
		if (minDis > 0.01)
			return -1; // too far
		
		return minIndex;
	}
	
	// Returns sTime1 - sTime2 in minutes
	function diffTime(sTime1, sTime2)
	{
		var s1 = sTime1.split('.')[0]; // remove milliseconds
		var s2 = sTime2.split('.')[0];
		var minutes = (Date.parse(s1) - Date.parse(s2)) / 60000;
		return "" + Math.round(minutes) + "min";
	}
	
</script>
</head>
<body onload="start()">
  <div id="mapDiv" style="position: relative; width: 100%; height: 100%;"></div> 
  <!--div id="mapDiv" style="position: relative; width: 400px; height: 400px;"></div--> 
</body>
</html>
